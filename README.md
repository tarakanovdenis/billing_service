# Billing Service

Проект состоит из следующих сервисов:
- **billing_service**: описание и архитектура сервиса представлены в файле `Billing Service Description.pdf`. В сервисе пользователю доступно:
    - создание профиля, через который он может завести банковский счет в любой из доступных валют (RUB, USD, CNY, EUR, PNT - встроенная валюта "Point").
    - пополнение банковского счета в валюте Point любой из доступных валют через реализованную конвертацию валют, исходя из установленного курса USD/PNT в сервисе и актуальных курсов валют, получаемых через API стороненного сервиса с помощью **Celery**. Payment System Provider -  **Stripe**.
    - покупка подписки на 1, 3, 6 через frontend и переход на **Stripe**.
    - сохранение и получение истории по проведенным транзакциям. Сохранение истории транзацкии реализовано с помощью **MongoDB**.
- **notification_service**: сервис для отправки уведомлений, персональных сообщений пользователям посредством получения сообщений из **RabbitMQ**. Также реализована панель администратора сервиса нотификации для отправки пользователям различных сообщений, например, о выходе новых фильмов.
- **auth**: сервис аутентификации и авторизации. Механизм аутентификации и авторизации реализуется через выдачу **JWT-токенов** (access и refresh). В сервисе реализовано взаимодейтсвие с сервисом нотификации через брокер сообщений **RabbitMQ** - пользователь получает персональные сообщения при регистрации и восстановлении пароля, регистрация и аутентификация с использованием **OAuth2** - протокол взаимодействия с Google API, также реализована трассировка запросов в сервис Auth и подключения **Jaeger**. Выполнено **партицирование** таблицы для сохранения истории входов пользователей по типам устройств.
Помимо этого сервис содержит:
    - Через декоратор добавлены проверка прав пользователя для авторизации (в проекте на текущий момент три роли: `public_user`, `admin`, `super_user`) при выполнении запросов по эндпоинтам сервиса.
    - Для создания пользователя можно воспользоватьcя следующей командой, находясь в корневой директории проекта: `python -m src.core.createsuperuser`.
    - Также используется декоратор для ограничения количества запросов к серверу с использованием **Redis**.
    - Для работы **Jaeger** необходимо в файле `./auth/.env` перевести значение переменной `JAEGER_CONFIGURE_TRACER` в значение `True` и запустить скрипт в корневой директории `run_jaeger.sh`. По умолчанию трассировка отключена из-за необходимости наличия в заголовках запросов `X-Request-Id`, из-за чего отсутствует возможность регистрации и аутентификации пользователей через социальные сети.
    - Для доступа к эндпоинту `/auth/login` с других доменов настроен CORS.
    - Для регистрации с использованием OAuth2 необходимо перейти по эндпоинту `/oauth/`.
    - После старта Auth сервиса создаются основные таблицы. При этом необходимо вручную создать партицированные таблицы:
        - `docker compose exec -it auth_db psql -U $(echo $POSTGRES_USER) -d $(echo $POSTGRES_DB) -f create_partition_table_entry_histories.ddl`

## Запуск проекта
Проект запускается через docker-compose и состоит из следующих контейнеров:
- auth_backend
- auth_db
- redis
- rabbitmq
- notification_service_backend
- billing_db
- billing_service_backend
- mongodb
